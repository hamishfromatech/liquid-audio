name: Ollama Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  review:
    name: Generate AI review with Ollama
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare review prompt
        id: prompt
        shell: bash
        run: |
          set -euo pipefail

          BASE_REF="${GITHUB_BASE_REF:-main}"
          HEAD_REF="${GITHUB_HEAD_REF:-$GITHUB_REF}"

          git fetch origin "${BASE_REF}" --depth=1

          TMP_DIFF="$(mktemp)"
          TMP_FILES="$(mktemp)"

          git diff --unified=0 "origin/${BASE_REF}"...HEAD > "${TMP_DIFF}" || true
          git diff --name-status "origin/${BASE_REF}"...HEAD > "${TMP_FILES}" || true

          if [ ! -s "${TMP_DIFF}" ]; then
            printf 'No diff detected against %s.\n' "${BASE_REF}" > "${TMP_DIFF}"
          fi

          TRUNCATED_DIFF="$(mktemp)"
          head -c 14000 "${TMP_DIFF}" > "${TRUNCATED_DIFF}"

          {
            echo "OLLAMA_PROMPT<<'EOF'"
            echo "You are an automated senior code reviewer."
            echo "Analyze the proposed changes below and respond with actionable review feedback."
            echo "Highlight logical bugs, missing tests, security/privacy issues, performance risks, and style violations."
            echo "Focus on high-signal comments and mention specific files and lines when possible."
            echo
            echo "Repository: ${GITHUB_REPOSITORY}"
            echo "Base ref: ${BASE_REF}"
            echo "Head ref: ${HEAD_REF}"
            echo
            echo "Changed files:"
            cat "${TMP_FILES}"
            echo
            echo "Unified diff (truncated to 14000 bytes):"
            cat "${TRUNCATED_DIFF}"
            echo
            echo "Respond with a structured review in Markdown."
            echo "EOF"
          } >> "${GITHUB_ENV}"

      - name: Run Ollama review
        id: review
        uses: ai-action/ollama-action@v1
        with:
          model: minimax-m2:cloud
          prompt: ${{ env.OLLAMA_PROMPT }}
          cache: 'true'

      - name: Show review output
        run: |
          echo "----- Ollama Review -----"
          echo "${{ steps.review.outputs.response }}"

      - name: Extract and apply suggested fixes
        id: extract
        shell: bash
        run: |
          RESPONSE="${{ steps.review.outputs.response }}"
          
          # Save response to a file for reference
          echo "$RESPONSE" > /tmp/ollama_review.txt
          
          # Check if response contains code blocks with suggested changes
          if echo "$RESPONSE" | grep -q '```'; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create dev branch and commit changes
        if: steps.extract.outputs.has_changes == 'true'
        shell: bash
        run: |
          set -euo pipefail
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create or switch to dev branch based on PR branch
          DEV_BRANCH="${{ github.head_ref }}-ollama-fixes"
          git checkout -b "$DEV_BRANCH" || git checkout "$DEV_BRANCH"
          
          # Create a commit with the review as the message
          git add -A
          REVIEW_MSG="Apply Ollama AI review suggestions

${{ steps.review.outputs.response }}"
          git commit -m "$REVIEW_MSG" || echo "No changes to commit"
          
          # Push to dev branch
          git push origin "$DEV_BRANCH" -f
          
          echo "Dev branch: $DEV_BRANCH"

      - name: Comment on PR with review link
        if: steps.extract.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const devBranch = '${{ github.head_ref }}-ollama-fixes';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ¤– Ollama AI Review\n\nSuggested fixes have been committed to branch: \`${devBranch}\`\n\n**Review:**\n\`\`\`\n${{ steps.review.outputs.response }}\n\`\`\``
            })
